<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BLOBBY: Parenthood Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
      
      /* Connection lines */
      .connection-path { fill: none; transition: all 0.3s; pointer-events: none; opacity: 0.8; stroke-linecap: round; }
      .connection-hit-area { fill: none; stroke: transparent; stroke-width: 15px; cursor: pointer; pointer-events: stroke; }
      .connection-hit-area:hover + .connection-path { stroke-width: 4px !important; opacity: 1; filter: drop-shadow(0 0 3px rgba(0,0,0,0.2)); }
      
      /* Dragging visuals */
      .is-dragging { cursor: grabbing !important; }
      .drag-target-hover { transform: scale(1.1); filter: brightness(1.1); }
      
      .notes-open { transform: translateY(0); }
      .notes-closed { transform: translateY(calc(100% - 40px)); }
      
      /* Post-it rotation classes */
      .rotate-rnd-1 { transform: rotate(1deg); }
      .rotate-rnd-neg-1 { transform: rotate(-1deg); }
      .rotate-rnd-2 { transform: rotate(2deg); }
      
      /* Robust Shadow */
      .shadow-hard { box-shadow: 3px 3px 0px 0px rgba(15, 23, 42, 1); }
    </style>
    <script type="importmap">
{
  "imports": {
    "d3-scale": "https://esm.run/d3-scale",
    "d3-time": "https://esm.run/d3-time",
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://esm.sh/react@^19.2.1",
    "lucide-react": "https://esm.sh/lucide-react@^0.560.0",
    "react/": "https://esm.sh/react@^19.2.1/"
  }
}
</script>
</head>
<body class="bg-white font-sans text-slate-900 overflow-hidden h-screen flex flex-col">

    <!-- Header -->
    <header class="flex-none px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-white z-40 shadow-sm">
        <div class="flex items-center space-x-3">
            <div class="bg-pink-100 p-2 rounded-lg text-pink-600">
                <i data-lucide="baby" width="24" height="24"></i>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold tracking-tight text-slate-900 leading-none">BLOBBY</h1>
                    <div id="header-clock" class="hidden sm:block text-[10px] font-mono font-medium text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-100 uppercase tracking-wide"></div>
                </div>
                <p class="text-[10px] md:text-xs text-slate-400 font-medium italic mt-1 max-w-xs leading-tight">
                    All these milestones and facts are indications do not stress if it is different. Each child is unique.
                </p>
            </div>
        </div>

        <div class="flex items-center space-x-4">
            <!-- Stats Counters -->
            <div class="hidden xl:flex items-center space-x-3 text-sm">
                <button onclick="app.openDrawer('MILESTONE')" class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-md border border-slate-200 hover:bg-slate-100 hover:border-amber-300 transition-all group">
                    <span class="text-slate-500 group-hover:text-amber-600">Milestones</span>
                    <span id="stat-milestone" class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </button>
                <button onclick="app.openDrawer('TODO')" class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-md border border-slate-200 hover:bg-slate-100 hover:border-blue-300 transition-all group">
                    <span class="text-slate-500 group-hover:text-blue-600">To-Dos</span>
                    <span id="stat-todo" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </button>
                <div class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-md border border-slate-200">
                    <span class="text-slate-500">Facts</span>
                    <span id="stat-fact" class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </div>
            </div>

            <div class="h-8 w-px bg-slate-200 mx-1 hidden md:block"></div>

            <!-- Controls -->
            <div class="flex items-center space-x-3">
                
                <button onclick="app.scrollToDate(new Date())" class="flex items-center space-x-1 bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-50 hover:text-slate-900 transition-all text-sm font-medium" title="Jump to Today">
                    <i data-lucide="calendar-clock" class="text-slate-500" width="16"></i>
                    <span class="hidden sm:inline">Today</span>
                </button>

                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-slate-600 hidden sm:block">Due Date:</label>
                    <input type="date" id="due-date-input" class="border border-slate-300 rounded-md px-2 py-1.5 text-sm focus:ring-2 focus:ring-pink-500 outline-none w-32 md:w-auto">
                </div>

                <button onclick="app.openEditor(null, 'marker')" class="flex items-center space-x-1 bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-50 hover:text-slate-900 transition-all text-sm font-medium">
                    <i data-lucide="flag" class="text-pink-500" width="16"></i>
                    <span class="hidden sm:inline">Add Cue</span>
                </button>

                <button id="btn-generate" onclick="app.generatePlan()" class="flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:from-indigo-700 hover:to-purple-700 disabled:opacity-50 transition-all shadow-md hover:shadow-lg text-sm font-medium">
                    <i data-lucide="wand-2" width="18"></i>
                    <span class="hidden sm:inline">AI Plan</span>
                </button>

                <div class="h-8 w-px bg-slate-200 mx-1 hidden md:block"></div>
                
                <!-- Storage Actions -->
                <div class="flex items-center space-x-1">
                    <input type="file" id="file-input" accept=".json" class="hidden">
                    <button onclick="document.getElementById('file-input').click()" class="p-2 text-slate-500 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" title="Load">
                        <i data-lucide="upload" width="20"></i>
                    </button>
                    <button onclick="app.exportData()" class="p-2 text-slate-500 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" title="Save">
                        <i data-lucide="save" width="20"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Timeline Area -->
    <main class="flex-1 relative overflow-hidden bg-slate-50">
        <!-- Floating Navigation & Zoom Controls -->
        <div class="absolute top-4 right-4 z-20 flex space-x-2 bg-white p-1 rounded-lg shadow-md border border-slate-200">
            <button onclick="app.scrollToDate(new Date())" class="p-2 hover:bg-slate-100 rounded-md text-slate-600" title="Jump to Today">
                <i data-lucide="calendar" width="20"></i>
            </button>
            <div class="w-px bg-slate-200 my-1"></div>
            <button onclick="app.zoom(-5)" class="p-2 hover:bg-slate-100 rounded-md text-slate-600"><i data-lucide="zoom-out" width="20"></i></button>
            <div class="w-px bg-slate-200 my-1"></div>
            <button onclick="app.zoom(5)" class="p-2 hover:bg-slate-100 rounded-md text-slate-600"><i data-lucide="zoom-in" width="20"></i></button>
        </div>

        <div id="timeline-container" class="w-full h-full overflow-x-auto overflow-y-hidden relative no-scrollbar cursor-crosshair">
            <div id="timeline-track" class="relative h-full min-w-full">
                <!-- Grid Layer -->
                <div id="timeline-grid" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0"></div>

                <!-- Axis -->
                <div id="timeline-axis" class="absolute top-0 left-0 w-full h-[50px] border-b border-slate-300 bg-slate-50/90 backdrop-blur-sm sticky z-10 select-none"></div>
                
                <!-- Connections SVG Layer -->
                <svg id="timeline-connections" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 overflow-visible"></svg>

                <!-- Content Layers -->
                <div id="timeline-markers"></div>
                <div id="timeline-events"></div>
                
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-slate-400 text-sm pointer-events-none bg-white/50 px-2 rounded backdrop-blur-sm">
                    <span id="instruction-text">Scroll to explore • Click empty space to add event • Drag markers to connect</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Notes Panel (Persistent) -->
    <div id="notes-panel" class="fixed bottom-4 right-4 w-72 md:w-96 bg-yellow-50 rounded-xl shadow-2xl z-50 border border-yellow-200 flex flex-col transition-transform duration-300 notes-open">
        <div class="flex justify-between items-center p-3 border-b border-yellow-200 bg-yellow-100/50 rounded-t-xl cursor-pointer" onclick="app.toggleNotes()">
            <div class="flex items-center space-x-2 text-yellow-800 font-bold text-sm">
                <i data-lucide="notebook-pen" width="16"></i>
                <span>Personal Notes</span>
            </div>
            <button class="text-yellow-700 hover:text-yellow-900">
                <i data-lucide="chevron-down" id="notes-chevron" width="18" class="transition-transform"></i>
            </button>
        </div>
        <textarea id="notes-area" class="w-full h-40 p-4 bg-transparent outline-none text-sm text-slate-700 resize-none font-medium leading-relaxed" placeholder="Write your thoughts, questions for the doctor, or shopping lists here..."></textarea>
    </div>

    <!-- Event Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                <h2 id="editor-title" class="text-lg font-bold text-gray-800">Edit Item</h2>
                <button onclick="app.closeEditor()" class="p-1 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="text-gray-500" width="20"></i></button>
            </div>
            
            <form id="editor-form" class="p-6 space-y-4 overflow-y-auto">
                <!-- ID is tracked in state.editingId, but we keep this just in case -->
                <input type="hidden" id="edit-id">
                
                <!-- Type Selection -->
                <div class="flex p-1 bg-slate-100 rounded-lg mb-2">
                    <button type="button" onclick="app.setEditorType('standard')" id="type-standard" class="flex-1 py-2 text-sm font-medium rounded-md transition-all flex justify-center items-center">
                        <i data-lucide="layout" width="16" class="mr-2"></i> Card
                    </button>
                    <button type="button" onclick="app.setEditorType('marker')" id="type-marker" class="flex-1 py-2 text-sm font-medium rounded-md transition-all flex justify-center items-center">
                        <i data-lucide="flag" width="16" class="mr-2"></i> Visual Cue
                    </button>
                </div>

                <!-- Appearance Selection (Dynamic) -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Appearance</label>
                    <div id="appearance-options" class="grid grid-cols-4 gap-2">
                        <!-- Options injected by JS -->
                    </div>
                    <input type="hidden" id="edit-variant">
                </div>

                <div class="h-px bg-slate-100 my-2"></div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="edit-title" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="edit-category" onchange="app.handleCategoryChange(this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="MILESTONE">MILESTONE</option>
                            <option value="TODO">TODO</option>
                            <option value="MEDICAL">MEDICAL</option>
                            <option value="FACT">FACT</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                    <div id="icon-picker" class="grid grid-cols-5 gap-2"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                    <div class="flex items-center space-x-2">
                        <input type="color" id="edit-color" class="h-10 w-20 p-1 rounded border cursor-pointer">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="edit-desc" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                </div>

                <div id="completed-check-wrapper" class="flex items-center space-x-2 pt-2">
                    <input type="checkbox" id="edit-completed" class="w-4 h-4 text-blue-600 rounded">
                    <label for="edit-completed" class="text-sm font-medium text-gray-700">Mark as Completed</label>
                </div>

                <div class="flex justify-between pt-2 mt-4 border-t border-gray-100 flex-shrink-0">
                    <button type="button" id="btn-delete" onclick="app.deleteCurrentEvent()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center text-sm font-medium">
                        <i data-lucide="trash-2" width="16" class="mr-2"></i> Delete
                    </button>
                    <button type="submit" class="px-6 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 flex items-center text-sm font-medium shadow-lg">
                        <i data-lucide="save" width="16" class="mr-2"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Drawer -->
    <div id="drawer-overlay" onclick="app.closeDrawer()" class="fixed inset-0 z-50 bg-black/20 backdrop-blur-[1px] hidden transition-opacity duration-200"></div>
    <div id="drawer" class="fixed top-0 right-0 z-50 h-full w-full max-w-md bg-white shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col">
        <div class="p-5 border-b flex justify-between items-center bg-slate-50">
            <div>
                <h2 id="drawer-title" class="text-xl font-bold text-slate-800 flex items-center gap-2"></h2>
                <p id="drawer-subtitle" class="text-sm text-slate-500 mt-1"></p>
            </div>
            <button onclick="app.closeDrawer()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                <i data-lucide="x" class="text-slate-600" width="20"></i>
            </button>
        </div>
        <div id="drawer-content" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/30"></div>
    </div>

    <script type="module">
        import * as d3 from "d3-scale";
        import { GoogleGenAI, Type } from "@google/genai";

        // --- CONSTANTS ---
        const COLORS = {
            MILESTONE: '#f59e0b', // Amber
            TODO: '#3b82f6',      // Blue
            MEDICAL: '#8b5cf6',   // Violet
            FACT: '#fcd34d',      // Post-it Yellow (default for Facts)
            OTHER: '#10b981'      // Emerald
        };
        const ICONS = ['baby', 'star', 'heart', 'flag', 'alert', 'gift', 'calendar', 'zap', 'check'];
        const VIEW_START = new Date('2024-01-01');
        const VIEW_END = new Date('2035-12-31');

        const VARIANTS = {
            standard: [
                { id: 'modern', label: 'Modern', icon: 'layout' },
                { id: 'postit', label: 'Post-it', icon: 'sticky-note' },
                { id: 'simple', label: 'Simple', icon: 'list-todo' },
                { id: 'robust', label: 'Robust', icon: 'shield' }
            ],
            marker: [
                { id: 'badge', label: 'Badge', icon: 'circle-dot' },
                { id: 'pin', label: 'Pin', icon: 'map-pin' },
                { id: 'orb', label: 'Orb', icon: 'sun' }
            ]
        };

        // --- STATE ---
        const state = {
            events: [],
            connections: [], // { id, from: eventId, to: eventId }
            notes: "",
            dueDate: new Date('2026-02-14'),
            zoom: 25, // px per day
            currentEditorType: 'standard',
            drawerCategory: null,
            dragSourceId: null,
            editingId: null // Explicitly track what we are editing
        };

        // --- INIT ---
        window.app = {
            state,
            init: () => {
                app.loadData();
                app.renderHeader();
                app.renderTimeline();
                app.updateClock();
                setInterval(app.updateClock, 1000);
                
                // Add global mouse events for dragging
                document.addEventListener('mousemove', app.handleDragMove);
                document.addEventListener('mouseup', app.handleDragEnd);

                // Event Listeners
                document.getElementById('timeline-container').addEventListener('click', (e) => {
                    if (e.target.id === 'timeline-track' || e.target.id === 'timeline-container' || e.target.id === 'timeline-grid') {
                        const rect = document.getElementById('timeline-container').getBoundingClientRect();
                        const scrollLeft = document.getElementById('timeline-container').scrollLeft;
                        const clickX = e.clientX - rect.left + scrollLeft;
                        const date = app.getDateFromX(clickX);
                        app.openEditor(null, 'standard', date);
                    }
                });

                document.getElementById('due-date-input').addEventListener('change', (e) => {
                    state.dueDate = new Date(e.target.value);
                    app.saveData();
                    app.renderTimeline();
                    app.scrollToDue();
                });

                document.getElementById('file-input').addEventListener('change', app.importData);
                document.getElementById('editor-form').addEventListener('submit', app.handleEditorSubmit);
                document.getElementById('notes-area').addEventListener('input', (e) => {
                    state.notes = e.target.value;
                    app.saveData();
                });

                setTimeout(() => app.scrollToDue(), 100);
            },

            // --- DRAG AND DROP LOGIC ---
            
            handleDragStart: (e, id) => {
                // Determine if it's a left click (standard click)
                if (e.button !== 0) return;
                
                state.dragSourceId = id;
                state.dragStartCoords = { x: e.clientX, y: e.clientY };
                
                // Create drag line element
                const svg = document.getElementById('timeline-connections');
                const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                line.setAttribute("id", "drag-line");
                line.setAttribute("class", "connection-path");
                line.setAttribute("stroke-dasharray", "5,5");
                line.setAttribute("stroke-opacity", "0.6");
                
                const sourceEvent = state.events.find(ev => ev.id === id);
                if (sourceEvent) {
                     line.setAttribute("stroke", sourceEvent.color);
                     line.setAttribute("stroke-width", "3");
                }
                
                svg.appendChild(line);
                
                // Prevent text selection during drag
                document.body.style.userSelect = 'none';
            },

            handleDragMove: (e) => {
                if (!state.dragSourceId) return;

                const container = document.getElementById('timeline-container');
                const rect = container.getBoundingClientRect();
                
                // Calculate drag distance to determine if it's a "drag" or just a "click"
                const dx = e.clientX - state.dragStartCoords.x;
                const dy = e.clientY - state.dragStartCoords.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > 5) {
                    container.classList.add('is-dragging');
                    
                    // Draw Line
                    const sourceEvent = state.events.find(ev => ev.id === state.dragSourceId);
                    if (sourceEvent && app.timeScale) {
                        const x1 = app.timeScale(new Date(sourceEvent.date));
                        // Approximate vertical center for cards vs markers
                        const y1 = sourceEvent.type === 'marker' ? 55 : 100; 
                        
                        const mouseX = e.clientX - rect.left + container.scrollLeft;
                        const mouseY = e.clientY - rect.top;
                        
                        const line = document.getElementById('drag-line');
                        if (line) {
                            // Simple curve to mouse pointer
                            const cx = (x1 + mouseX) / 2;
                            const cy = (y1 + mouseY) / 2;
                            line.setAttribute("d", `M ${x1} ${y1} Q ${cx} ${cy} ${mouseX} ${mouseY}`);
                        }
                    }
                }
            },

            handleDragEnd: (e, targetId) => {
                if (!state.dragSourceId) return;

                const sourceId = state.dragSourceId;
                const container = document.getElementById('timeline-container');
                
                // Cleanup visuals
                const line = document.getElementById('drag-line');
                if (line) line.remove();
                container.classList.remove('is-dragging');
                document.body.style.userSelect = '';
                
                // Logic: Click vs Drag
                const dx = e.clientX - state.dragStartCoords.x;
                const dy = e.clientY - state.dragStartCoords.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                state.dragSourceId = null;
                state.dragStartCoords = null;

                if (dist < 5) {
                    // It was a click, open editor for source
                    // (Unless we clicked a handle, but handles are gone now)
                    app.openEditor(sourceId);
                } else {
                    // It was a drag. Check if we dropped on a valid target
                    // Note: 'targetId' comes from the onmouseup handler on the cue elements
                    if (targetId && typeof targetId === 'string' && targetId !== sourceId) {
                        // Create Connection
                        // Check if exists
                        const exists = state.connections.find(c => 
                            (c.from === sourceId && c.to === targetId) || 
                            (c.from === targetId && c.to === sourceId)
                        );
                        
                        if (!exists) {
                            state.connections.push({ id: crypto.randomUUID(), from: sourceId, to: targetId });
                            app.saveData();
                            app.renderTimeline();
                        }
                    }
                }
            },

            updateClock: () => {
                const now = new Date();
                const str = now.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                }); // e.g. Mon, 14 Dec 2025
                const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const el = document.getElementById('header-clock');
                if(el) el.innerText = `${str} • ${time}`;
            },

            formatDateForInput: (date) => date.toISOString().split('T')[0],
            formatDateDisplay: (dateStr) => {
                const parts = dateStr.split('-');
                if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
                return dateStr;
            },
            
            saveData: () => {
                const data = {
                    dueDate: state.dueDate.toISOString(),
                    events: state.events,
                    connections: state.connections,
                    notes: state.notes,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('blobby_data', JSON.stringify(data));
                app.renderHeader();
            },
            
            loadData: () => {
                const stored = localStorage.getItem('blobby_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    state.dueDate = new Date(data.dueDate);
                    state.events = data.events || [];
                    state.connections = data.connections || [];
                    state.notes = data.notes || "";
                }
                document.getElementById('due-date-input').value = app.formatDateForInput(state.dueDate);
                document.getElementById('notes-area').value = state.notes;
            },

            exportData: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                    dueDate: state.dueDate.toISOString(),
                    events: state.events,
                    connections: state.connections,
                    notes: state.notes
                }, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = `blobby-plan-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },

            importData: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        state.dueDate = new Date(data.dueDate);
                        state.events = data.events || [];
                        state.connections = data.connections || [];
                        state.notes = data.notes || "";
                        
                        document.getElementById('due-date-input').value = app.formatDateForInput(state.dueDate);
                        document.getElementById('notes-area').value = state.notes;
                        
                        app.saveData();
                        app.renderTimeline();
                        app.renderHeader();
                        app.scrollToDue();
                        alert('Plan loaded successfully!');
                    } catch(err) {
                        alert('Invalid file format');
                    }
                };
                reader.readAsText(file);
            },

            generatePlan: async () => {
                const btn = document.getElementById('btn-generate');
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin" width="18"></i> Generating...`;
                lucide.createIcons();

                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const dueDateStr = app.formatDateForInput(state.dueDate);
                    
                    const prompt = `I am expecting a baby on ${dueDateStr}. 
                    Focus on the period from 3 months before due date to 6 months after.
                    Generate a JSON list of:
                    1. Milestones (category: MILESTONE)
                    2. Logistics To-Dos (category: TODO)
                    3. Medical Appts (category: MEDICAL)
                    4. Fun Facts (category: FACT)
                    
                    Schema: [{ title, description, daysOffsetFromDue (number), category (one of MILESTONE, TODO, MEDICAL, FACT, OTHER) }]`;

                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: prompt,
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        title: { type: Type.STRING },
                                        description: { type: Type.STRING },
                                        daysOffsetFromDue: { type: Type.NUMBER },
                                        category: { type: Type.STRING, enum: Object.keys(COLORS) }
                                    },
                                    required: ["title", "description", "daysOffsetFromDue", "category"]
                                }
                            }
                        }
                    });

                    const raw = JSON.parse(response.text);
                    const newEvents = raw.map(item => {
                        const date = new Date(state.dueDate);
                        date.setDate(date.getDate() + item.daysOffsetFromDue);
                        
                        // Auto-assign styles
                        let variant = 'modern';
                        let type = 'standard';
                        let color = COLORS[item.category] || COLORS.OTHER;
                        
                        if (item.category === 'FACT') {
                            variant = 'postit';
                            color = '#fef08a'; // Yellow-200
                        } else if (item.category === 'TODO') {
                            variant = 'simple';
                        } else if (item.category === 'MILESTONE') {
                            variant = 'robust';
                        }

                        return {
                            id: crypto.randomUUID(),
                            title: item.title,
                            description: item.description,
                            date: app.formatDateForInput(date),
                            category: item.category,
                            color: color,
                            type: type,
                            variant: variant,
                            icon: item.category === 'MILESTONE' ? 'star' : 'flag',
                            isCompleted: false
                        };
                    });

                    state.events = [...state.events, ...newEvents];
                    app.saveData();
                    app.renderTimeline();
                } catch (e) {
                    console.error(e);
                    alert("Failed to generate plan.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="wand-2" width="18"></i> <span class="hidden sm:inline">AI Plan</span>`;
                    lucide.createIcons();
                }
            },

            toggleNotes: () => {
                const panel = document.getElementById('notes-panel');
                const chevron = document.getElementById('notes-chevron');
                if (panel.classList.contains('notes-open')) {
                    panel.classList.replace('notes-open', 'notes-closed');
                    chevron.classList.add('rotate-180');
                } else {
                    panel.classList.replace('notes-closed', 'notes-open');
                    chevron.classList.remove('rotate-180');
                }
            },

            timeScale: null,

            zoom: (delta) => {
                state.zoom = Math.max(5, Math.min(100, state.zoom + delta));
                app.renderTimeline();
            },

            getDateFromX: (x) => {
                return app.timeScale.invert(x).toISOString().split('T')[0];
            },

            scrollToDue: () => {
                app.scrollToDate(state.dueDate);
            },

            scrollToDate: (date) => {
                if(!app.timeScale) return;
                const x = app.timeScale(date);
                const container = document.getElementById('timeline-container');
                container.scrollLeft = x - container.clientWidth / 2;
            },

            renderTimeline: () => {
                const totalDays = Math.ceil((VIEW_END - VIEW_START) / (1000 * 60 * 60 * 24));
                const totalWidth = totalDays * state.zoom;
                
                app.timeScale = d3.scaleTime().domain([VIEW_START, VIEW_END]).range([0, totalWidth]);

                const track = document.getElementById('timeline-track');
                track.style.width = `${totalWidth}px`;
                
                // Update instruction text
                const instr = document.getElementById('instruction-text');
                instr.innerHTML = 'Scroll to explore • Click empty space to add event • Drag markers to connect';

                const axisHTML = [];
                const gridHTML = [];
                let curr = new Date(VIEW_START);
                while(curr <= VIEW_END) {
                    const isMonthStart = curr.getDate() === 1;
                    const x = app.timeScale(curr);
                    const showDay = state.zoom >= 20;
                    const showTick = state.zoom >= 8;

                    // Grid Lines (Mondays)
                    if (curr.getDay() === 1) { // 1 = Monday
                         gridHTML.push(`<div class="absolute top-0 bottom-0 border-l-2 border-slate-200/70" style="left: ${x}px"></div>`);
                    }

                    if (isMonthStart || showTick) {
                        const h = isMonthStart ? 'h-6 border-slate-400' : 'h-3 border-slate-200';
                        let label = '';
                        if (isMonthStart) {
                            label = `<span class="font-bold text-slate-700">${curr.toLocaleDateString('en-GB', { month: 'short' })}</span>`;
                            if (state.zoom > 15) label += `<span class="text-slate-400 font-normal ml-1">${curr.getFullYear()}</span>`;
                        } else if (showDay) {
                            label = `<span class="text-slate-400 text-[10px]">${curr.getDate()}</span>`;
                        }

                        axisHTML.push(`
                            <div class="absolute bottom-0 border-l px-1 text-xs whitespace-nowrap transition-opacity ${h}" style="left: ${x}px">
                                ${label}
                            </div>
                        `);
                    }
                    curr.setDate(curr.getDate() + 1);
                }
                document.getElementById('timeline-axis').innerHTML = axisHTML.join('');
                document.getElementById('timeline-grid').innerHTML = gridHTML.join('');

                const markersEl = document.getElementById('timeline-markers');
                const eventsEl = document.getElementById('timeline-events');
                markersEl.innerHTML = '';
                eventsEl.innerHTML = '';

                // Due Date Marker
                const dueX = app.timeScale(state.dueDate);
                markersEl.innerHTML += `
                    <div class="absolute top-[50px] bottom-0 w-1 bg-gradient-to-b from-pink-400 to-pink-200/20 pointer-events-none z-0" style="left: ${dueX}px; transform: translateX(-50%)"></div>
                    <div class="absolute top-[26px] z-30 pointer-events-none" style="left: ${dueX}px; transform: translateX(-50%)">
                        <div class="flex flex-col items-center group">
                            <div class="bg-pink-500 text-white p-2 rounded-full shadow-lg border-4 border-slate-50 relative">
                                <i data-lucide="baby" width="24" height="24"></i>
                                <div class="absolute inset-0 rounded-full animate-ping bg-pink-400 opacity-20 duration-1000"></div>
                            </div>
                            <div class="mt-1 bg-white/90 backdrop-blur text-pink-600 text-[11px] font-bold px-3 py-0.5 rounded-full border border-pink-200 shadow-sm whitespace-nowrap">
                                DUE: ${app.formatDateDisplay(app.formatDateForInput(state.dueDate))}
                            </div>
                        </div>
                    </div>
                `;

                // Custom Markers
                const markers = state.events.filter(e => e.type === 'marker');
                markers.forEach(ev => {
                    const x = app.timeScale(new Date(ev.date));
                    const iconEl = `<i data-lucide="${ev.icon || 'star'}" width="20" height="20"></i>`;
                    const variant = ev.variant || 'badge';

                    // Marker Variants
                    let markerInner = '';
                    if (variant === 'pin') {
                         markerInner = `
                            <div class="cursor-pointer hover:-translate-y-1 transition-transform relative text-white">
                                <div class="w-8 h-8 rounded-t-full rounded-bl-full rotate-45 flex items-center justify-center shadow-md border-2 border-white" style="background-color: ${ev.color};">
                                    <div class="-rotate-45">${iconEl}</div>
                                </div>
                            </div>
                        `;
                    } else if (variant === 'orb') {
                        markerInner = `
                            <div class="cursor-pointer hover:scale-110 transition-transform relative">
                                <div class="w-8 h-8 rounded-full shadow-[0_0_15px_rgba(0,0,0,0.2)] border-2 border-white flex items-center justify-center backdrop-blur-sm" style="background: radial-gradient(circle at 30% 30%, white, ${ev.color});">
                                     <div class="text-slate-900 opacity-70">${iconEl}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Default Badge
                        markerInner = `
                            <div class="cursor-pointer hover:scale-110 transition-transform p-2 rounded-full shadow-lg border-4 border-slate-50 relative text-white" style="background-color: ${ev.color}">
                                ${iconEl}
                            </div>
                        `;
                    }

                    const markerHTML = `
                        <div class="absolute top-[50px] bottom-0 w-1 pointer-events-none z-0 opacity-80" style="left: ${x}px; transform: translateX(-50%); background: linear-gradient(to bottom, ${ev.color}, transparent);"></div>
                        <div class="absolute top-[26px] z-30 transform -translate-x-1/2 left-[${x}px]" style="left: ${x}px">
                            <div 
                                class="flex flex-col items-center group relative hover:z-40"
                                onmousedown="app.handleDragStart(event, '${ev.id}')"
                                onmouseup="app.handleDragEnd(event, '${ev.id}')"
                            >
                                ${markerInner}
                                <div class="mt-1 bg-white/90 backdrop-blur text-[11px] font-bold px-3 py-0.5 rounded-full border shadow-sm whitespace-nowrap flex flex-col items-center pointer-events-none select-none" style="color: ${ev.color}; border-color: ${ev.color}">
                                    <span>${ev.title}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    markersEl.innerHTML += markerHTML;
                });

                // Standard Cards
                const cards = state.events.filter(e => e.type !== 'marker').sort((a, b) => new Date(a.date) - new Date(b.date));
                const lanes = [];
                const HEADER_H = 50;
                const PADDING = 40;
                const ROW_H = 60;

                cards.forEach((ev, i) => {
                    const x = app.timeScale(new Date(ev.date));
                    const w = ev.variant === 'robust' ? 180 : 160;
                    
                    let laneIdx = lanes.findIndex(endX => endX + 15 < x);
                    if (laneIdx === -1) {
                        laneIdx = lanes.length;
                        lanes.push(0);
                    }
                    lanes[laneIdx] = x + w;

                    const top = HEADER_H + PADDING + (laneIdx * (ROW_H + (ev.variant === 'postit' ? 20 : 0))); // Extra spacing for postits
                    const isDone = ev.isCompleted;
                    
                    let contentHTML = '';
                    let wrapperClass = `absolute group transition-all duration-200 cursor-pointer hover:z-20 ${isDone ? 'opacity-60 grayscale-[0.5]' : ''}`;
                    const variant = ev.variant || 'modern';
                    
                    // --- VARIANT RENDERERS ---
                    
                    if (variant === 'postit') {
                        // POST-IT STYLE
                        const rot = (i % 3 === 0) ? 'rotate-rnd-1' : (i % 3 === 1 ? 'rotate-rnd-neg-1' : 'rotate-rnd-2');
                        const hover = 'hover:rotate-0 hover:scale-110';
                        wrapperClass += ` ${rot} ${hover}`;
                        
                        contentHTML = `
                            <div class="bg-[#fef08a] text-yellow-900 p-3 shadow-md w-[150px] min-h-[80px] relative font-serif" style="background-color: ${ev.color}">
                                <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-16 h-4 bg-white/40 opacity-50 rotate-1"></div>
                                <h4 class="font-bold text-sm leading-tight mb-1 italic pointer-events-none select-none">${ev.title}</h4>
                                <p class="text-[10px] opacity-90 leading-tight line-clamp-3 pointer-events-none select-none">${ev.description || ''}</p>
                            </div>
                        `;
                    } 
                    else if (variant === 'simple') {
                        // SIMPLE / TODO STYLE
                        wrapperClass += ' hover:scale-105';
                        contentHTML = `
                             <div class="bg-white border rounded p-2 w-[150px] flex items-center space-x-2 shadow-sm hover:border-blue-400 group-hover:shadow-md transition-all" style="border-color: ${isDone ? '#cbd5e1' : ev.color}">
                                <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center flex-shrink-0" style="border-color: ${ev.color}">
                                    ${isDone ? `<div class="w-2 h-2 rounded-full bg-slate-400"></div>` : ''}
                                </div>
                                <span class="text-xs font-medium text-slate-700 truncate ${isDone ? 'line-through' : ''} pointer-events-none select-none">${ev.title}</span>
                            </div>
                        `;
                    }
                    else if (variant === 'robust') {
                        // ROBUST / MILESTONE STYLE
                        wrapperClass += ' hover:-translate-y-1';
                        contentHTML = `
                            <div class="bg-white border-2 border-slate-900 rounded-lg overflow-hidden w-[170px] shadow-hard">
                                <div class="bg-slate-900 text-white text-[10px] font-bold px-2 py-1 uppercase tracking-wider flex justify-between items-center" style="background-color: ${ev.color === '#f59e0b' ? '#0f172a' : ev.color}">
                                    <span class="pointer-events-none select-none">${ev.category}</span>
                                    ${isDone ? '<i data-lucide="check" width="12"></i>' : ''}
                                </div>
                                <div class="p-2">
                                    <h4 class="font-bold text-sm text-slate-900 leading-tight mb-1 pointer-events-none select-none">${ev.title}</h4>
                                    <p class="text-[10px] text-slate-500 pointer-events-none select-none">${app.formatDateDisplay(ev.date)}</p>
                                </div>
                            </div>
                        `;
                    }
                    else {
                        // MODERN / DEFAULT STYLE
                        wrapperClass += ' hover:scale-105';
                        const iconCheck = isDone ? `<i data-lucide="check-circle-2" class="text-green-500 mt-0.5 flex-shrink-0" width="12"></i>` : '';
                        contentHTML = `
                             <div class="rounded-lg shadow-sm border p-2 text-left relative overflow-hidden flex items-start space-x-2 bg-white" style="border-left: 4px solid ${isDone ? '#cbd5e1' : ev.color}">
                                ${iconCheck}
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-xs truncate ${isDone ? 'line-through text-slate-500' : 'text-slate-800'} pointer-events-none select-none">${ev.title}</h4>
                                    <p class="text-[10px] text-slate-500 truncate pointer-events-none select-none">${app.formatDateDisplay(ev.date)}</p>
                                </div>
                            </div>
                        `;
                    }

                    const cardHTML = `
                        <div 
                            class="${wrapperClass}" 
                            style="left: ${x}px; top: ${top}px;"
                            onmousedown="app.handleDragStart(event, '${ev.id}')"
                            onmouseup="app.handleDragEnd(event, '${ev.id}')"
                        >
                            ${variant !== 'postit' ? `<div class="absolute h-full w-0.5 bg-slate-300 -top-4 left-0 -z-10 group-hover:bg-slate-400 transition-colors" style="height: 20px;"></div>` : ''}
                            ${contentHTML}
                        </div>
                    `;
                    eventsEl.innerHTML += cardHTML;
                });

                app.renderConnections();
                lucide.createIcons();
            },

            // Unchanged from previous version but included for completeness of renderTimeline context
            renderConnections: () => {
                const svg = document.getElementById('timeline-connections');
                svg.innerHTML = '';
                
                state.connections.forEach(conn => {
                    const fromEv = state.events.find(e => e.id === conn.from);
                    const toEv = state.events.find(e => e.id === conn.to);
                    
                    if (fromEv && toEv) {
                        const x1 = app.timeScale(new Date(fromEv.date));
                        const x2 = app.timeScale(new Date(toEv.date));
                        
                        // Dynamic Y adjustment based on type
                        const y1 = fromEv.type === 'marker' ? 55 : 100;
                        const y2 = toEv.type === 'marker' ? 55 : 100;
                        
                        const cx = (x1 + x2) / 2;
                        const dist = Math.abs(x2 - x1);
                        const cy = Math.max(y1, y2) + Math.min(150, dist * 0.3);
                        
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        path.setAttribute("d", `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`);
                        path.setAttribute("class", "connection-path");
                        path.setAttribute("stroke", fromEv.color);
                        path.setAttribute("stroke-width", "2");
                        
                        const hitArea = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        hitArea.setAttribute("d", `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`);
                        hitArea.setAttribute("class", "connection-hit-area");
                        
                        const deleteHandler = (e) => {
                            e.stopPropagation();
                            if(confirm(`Remove connection between "${fromEv.title}" and "${toEv.title}"?`)) {
                                state.connections = state.connections.filter(c => c.id !== conn.id);
                                app.saveData();
                                app.renderTimeline();
                            }
                        };
                        
                        path.onclick = deleteHandler;
                        hitArea.onclick = deleteHandler;
                        
                        svg.appendChild(path);
                        svg.appendChild(hitArea);
                    }
                });
            },

            renderHeader: () => {
                const milestones = state.events.filter(e => e.category === 'MILESTONE').length;
                const todos = state.events.filter(e => e.category === 'TODO');
                const completedTodos = todos.filter(e => e.isCompleted).length;
                const facts = state.events.filter(e => e.category === 'FACT').length;

                const msEl = document.getElementById('stat-milestone');
                if(msEl) msEl.innerText = milestones;
                
                const todoEl = document.getElementById('stat-todo');
                if(todoEl) todoEl.innerHTML = completedTodos > 0 ? `<span class="opacity-60">${completedTodos}/</span>${todos.length}` : todos.length;
                
                const factEl = document.getElementById('stat-fact');
                if(factEl) factEl.innerText = facts;
            },

            openDrawer: (category) => {
                state.drawerCategory = category;
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('drawer-overlay');
                const content = document.getElementById('drawer-content');
                const title = document.getElementById('drawer-title');
                const subtitle = document.getElementById('drawer-subtitle');

                drawer.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);

                title.innerText = category === 'MILESTONE' ? 'Milestones' : 'To-Dos';
                const filtered = state.events.filter(e => e.category === category).sort((a,b) => new Date(a.date) - new Date(b.date));
                subtitle.innerText = `${filtered.length} items`;

                content.innerHTML = filtered.map(ev => `
                    <div onclick="app.openEditor('${ev.id}')" class="group flex items-start p-3 rounded-lg border bg-white hover:border-blue-300 cursor-pointer ${ev.isCompleted ? 'opacity-60' : ''}">
                        <div class="mt-1 mr-3 text-slate-400">
                             <i data-lucide="${ev.isCompleted ? 'check-circle-2' : 'circle'}" width="18"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-sm ${ev.isCompleted ? 'line-through' : ''}">${ev.title}</h3>
                            <p class="text-xs text-slate-500 mt-1">${app.formatDateDisplay(ev.date)}</p>
                        </div>
                    </div>
                `).join('') || '<p class="text-slate-400 text-center mt-10">No items found.</p>';
                lucide.createIcons();
            },

            closeDrawer: () => {
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('drawer-overlay');
                drawer.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 200);
            },

            openEditor: (id = null, type = 'standard', date = null) => {
                state.editingId = id;
                const modal = document.getElementById('editor-modal');
                modal.classList.remove('hidden');
                
                const event = id ? state.events.find(e => String(e.id) === String(id)) : null;
                
                const picker = document.getElementById('icon-picker');
                picker.innerHTML = ICONS.map(icon => `
                    <button type="button" class="p-2 rounded border hover:bg-slate-50 flex justify-center items-center icon-btn" data-icon="${icon}" onclick="app.selectIcon('${icon}')">
                        <i data-lucide="${icon}" width="18"></i>
                    </button>
                `).join('');
                lucide.createIcons();

                document.getElementById('edit-id').value = id || '';
                document.getElementById('edit-title').value = event ? event.title : '';
                document.getElementById('edit-date').value = event ? event.date : (date || app.formatDateForInput(new Date()));
                document.getElementById('edit-desc').value = event ? event.description || '' : '';
                document.getElementById('edit-category').value = event ? event.category : 'MILESTONE';
                document.getElementById('edit-color').value = event ? event.color : COLORS.MILESTONE;
                document.getElementById('edit-completed').checked = event ? event.isCompleted : false;
                
                app.setEditorType(event ? event.type : type);
                app.selectVariant(event ? (event.variant || 'modern') : null);
                
                if (event && event.icon) app.selectIcon(event.icon);
                else app.selectIcon('star');

                document.getElementById('btn-delete').style.display = id ? 'flex' : 'none';
                document.getElementById('editor-title').innerText = id ? 'Edit Item' : 'New Item';
            },

            closeEditor: () => {
                state.editingId = null;
                document.getElementById('editor-modal').classList.add('hidden');
            },

            setEditorType: (type) => {
                state.currentEditorType = type;
                const standardBtn = document.getElementById('type-standard');
                const markerBtn = document.getElementById('type-marker');
                
                if (type === 'standard') {
                    standardBtn.classList.add('bg-white', 'shadow-sm', 'text-slate-900');
                    standardBtn.classList.remove('text-slate-500');
                    markerBtn.classList.remove('bg-white', 'shadow-sm', 'text-slate-900');
                    markerBtn.classList.add('text-slate-500');
                } else {
                    markerBtn.classList.add('bg-white', 'shadow-sm', 'text-slate-900');
                    markerBtn.classList.remove('text-slate-500');
                    standardBtn.classList.remove('bg-white', 'shadow-sm', 'text-slate-900');
                    standardBtn.classList.add('text-slate-500');
                }
                app.renderAppearanceOptions();
            },

            renderAppearanceOptions: () => {
                const container = document.getElementById('appearance-options');
                const options = VARIANTS[state.currentEditorType] || [];
                const current = document.getElementById('edit-variant').value || options[0]?.id;

                container.innerHTML = options.map(opt => `
                    <div onclick="app.selectVariant('${opt.id}')" class="cursor-pointer border rounded-md p-2 flex flex-col items-center justify-center transition-all ${current === opt.id ? 'bg-slate-900 text-white border-slate-900' : 'bg-white hover:bg-slate-50 text-slate-600'}">
                        <i data-lucide="${opt.icon}" width="20" class="mb-1"></i>
                        <span class="text-[10px] font-medium">${opt.label}</span>
                    </div>
                `).join('');
                lucide.createIcons();
            },

            selectVariant: (variantId) => {
                const options = VARIANTS[state.currentEditorType] || [];
                if (!variantId || !options.find(o => o.id === variantId)) {
                    variantId = options[0]?.id;
                }
                document.getElementById('edit-variant').value = variantId;
                app.renderAppearanceOptions();
            },

            selectIcon: (iconName) => {
                document.querySelectorAll('.icon-btn').forEach(btn => {
                    if (btn.dataset.icon === iconName) {
                        btn.classList.add('bg-slate-800', 'text-white', 'border-slate-800');
                        btn.classList.remove('hover:bg-slate-50');
                    } else {
                        btn.classList.remove('bg-slate-800', 'text-white', 'border-slate-800');
                        btn.classList.add('hover:bg-slate-50');
                    }
                });
                state.selectedIcon = iconName;
            },

            handleCategoryChange: (val) => {
                document.getElementById('edit-color').value = COLORS[val] || '#000000';
                if (state.currentEditorType === 'standard') {
                    if (val === 'FACT') app.selectVariant('postit');
                    else if (val === 'TODO') app.selectVariant('simple');
                    else if (val === 'MILESTONE') app.selectVariant('robust');
                    else app.selectVariant('modern');
                }
            },

            handleEditorSubmit: (e) => {
                e.preventDefault();
                const id = state.editingId;
                const title = document.getElementById('edit-title').value;
                const date = document.getElementById('edit-date').value;
                const desc = document.getElementById('edit-desc').value;
                const category = document.getElementById('edit-category').value;
                const color = document.getElementById('edit-color').value;
                const isCompleted = document.getElementById('edit-completed').checked;
                const variant = document.getElementById('edit-variant').value;

                const eventData = {
                    id: id || crypto.randomUUID(),
                    title,
                    date,
                    description: desc,
                    category,
                    color,
                    isCompleted,
                    type: state.currentEditorType,
                    variant: variant,
                    icon: state.selectedIcon || 'star'
                };

                if (id) {
                    const idx = state.events.findIndex(e => String(e.id) === String(id));
                    if (idx !== -1) state.events[idx] = eventData;
                } else {
                    state.events.push(eventData);
                }

                app.saveData();
                app.renderTimeline();
                app.renderHeader(); // Ensure stats update
                app.closeEditor();
            },

            deleteCurrentEvent: () => {
                const id = state.editingId;
                if (!id) {
                    app.closeEditor();
                    return;
                }

                if (confirm('Delete this item?')) {
                    const idStr = String(id);
                    state.events = state.events.filter(e => String(e.id) !== idStr);
                    state.connections = state.connections.filter(c => String(c.from) !== idStr && String(c.to) !== idStr);
                    
                    app.saveData();
                    app.renderTimeline();
                    app.renderHeader();
                    app.closeEditor();
                }
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>